name: Release Backend

on:
  push:
    branches: [main]

env:
  CONTAINER_IMAGE: chr0nu5/base:pokedeiz-backend

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          npm install --legacy-peer-deps
          NODE_ENV=production npm run build

      - name: Copy Frontend Build to Backend
        run: |
          rm -rf backend/build
          cp -r frontend/build backend/

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and tag the image
        working-directory: ./backend
        run: |
          docker build . --file Dockerfile --tag $CONTAINER_IMAGE

      - name: Push
        working-directory: ./backend
        run: |
          docker push $CONTAINER_IMAGE

      - name: Deploy to Portainer
        run: |
          curl -X POST https://docker-threadripper.john.dev.br/api/webhooks/7efc4d04-5bec-4f51-b294-1af12f18bcf6

      - name: ðŸ“£ Notify Telegram (PokÃ©dex updated)
        env:
          BOT_TOKEN: "8302607422:AAHiqO5WUYCfGUUWJDoA3eeD-yLVlJqud7Y"
          CHAT_ID: "-1003319552798"
        run: |
          set -euo pipefail

          if [ -z "${BOT_TOKEN:-}" ] || [ -z "${CHAT_ID:-}" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN and/or TELEGRAM_CHAT_ID secrets"
            exit 1
          fi

          # Determine commit range since the last build.
          # This repo doesn't produce a "build artifact commit" in git, so we fall back
          # to a short recent changelog when we can't infer a range.
          PREV_BUILD_COMMIT=""
          if git rev-parse --git-dir >/dev/null 2>&1; then
            PREV_BUILD_COMMIT=$(git log -n 2 --format=%H -- .github/workflows/release.yml 2>/dev/null | tail -n 1 || true)
          fi

          RANGE=""
          if [ -n "$PREV_BUILD_COMMIT" ] && [ "$PREV_BUILD_COMMIT" != "$(git rev-parse HEAD)" ]; then
            RANGE="$PREV_BUILD_COMMIT..HEAD"
          fi

          # Build a human-friendly changelog from commit subjects (limit to Telegram 4096 chars).
          if [ -n "$RANGE" ]; then
            COMMITS=$(git log --no-merges --pretty=format:'%s' "$RANGE" | head -n 12)
          else
            COMMITS=$(git log --no-merges -n 8 --pretty=format:'%s')
          fi

          # Convert to bullets and lightly clean up common prefixes.
          COMMITS=$(printf "%s\n" "$COMMITS" \
            | sed -E 's/^[[:space:]]+//; s/^[-*]+[[:space:]]*//; s/^chore\([^)]*\):[[:space:]]*//I; s/^chore:[[:space:]]*//I; s/^fix:[[:space:]]*//I; s/^feat:[[:space:]]*//I; s/^refactor:[[:space:]]*//I' \
            | awk 'NF{print "â€¢ " $0}' \
            | head -n 12)

          if [ -z "$COMMITS" ]; then
            COMMITS="- (no commits found)"
          fi

          TEXT=$(printf "âœ… PokÃ©dex updated!\n\nðŸ“ Changes:\n\n%s\n\nðŸ”— Link:\n\nhttps://dex.john.dev.br\n" \
            "$COMMITS")

          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            > /dev/null
